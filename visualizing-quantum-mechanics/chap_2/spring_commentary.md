### なぜハミルトニアンが波打つのか（要約）
- 理想的には調和振動子のハミルトニアン H = T + V は一定ですが、数値積分では完全には保存されません。
- 現在の更新式は `v ← v + a·dt;  x ← x + v·dt` で、これは「オイラー・クロマー法（半陰的オイラー法）」＝シンプレクティック積分の一種です。
- シンプレクティック法はエネルギー発散を抑える代わりに、真のハミルトニアンの周りで小さく周期的に“揺れる（波打つ）”性質があります。これは仕様上の特徴で、エネルギー誤差は主にステップ幅 `dt` に依存します。
- さらに、オイラー・クロマー法では位置 `x` と速度 `v` が「半ステップずれた時間」に相当するため、同一時刻での `T(x,v)` として合算したときに小さな振動が生じやすいです。

### 技術的背景（少し詳しく）
- 今の更新式は標準の（完全な）陽的オイラー `x ← x + v·dt; v ← v + a·dt` ではなく、順序が逆のオイラー・クロマーです。これはシンプレクティックで、長時間の安定性が高く、エネルギーが単調に発散しにくい代わりに、一定値の周りで小振幅の振動（波打ち）が生じます。
- シンプレクティック法は真のハミルトニアンを厳密には保存せず、「修正ハミルトニアン（modified Hamiltonian）」をほぼ保存します。その差分が H(t) の見かけ上の振動として可視化されます。
- ハーモニック振動子では誤差の主成分は O(dt^2) で、`dt` を小さくすると振幅は縮み、線に近づきます。

### 影響する要因
- 時間刻み `dt`: 大きいほど数値誤差が増え、波打ちが目立ちます。
- 積分スキーム: オイラー・クロマー（半陰的）やリープフロッグ、Verlet などのシンプレクティック法は“波打つけれど発散しにくい”。陽的オイラーはエネルギーが一方向にずれやすい。高次のVerlet/Velocity-Verletは波打ちがより小さい。
- 位置と速度の時間ずれ: T と V を同一ステップで合算しても、`v` が実質的に半ステップ先行/遅行しているため、H に小さな擬似的振動が乗ります。

### 改善策（必要に応じて）
1) 時間刻みを小さくする
- 例: `dt = 0.005` や `0.002` にすると波打ちは目立ちにくくなります（計算負荷は増えます）。

2) 積分器を Velocity-Verlet（速度ベルレ）へ
- 手順の例:
    1. `v_half = v + (a(x)/2)·dt`
    2. `x_new = x + v_half·dt`
    3. `a_new = a(x_new)`
    4. `v_new = v_half + (a_new/2)·dt`
- Velocity-Verlet は同一時刻での `x` と `v` が整合的になり、エネルギー保存性がより良く、H の波打ちが小さくなります。

3) “ずれ”を意識して H を評価する
- 現在のスキームのままでも、T を「半ステップ速度」で評価する（あるいは V は位置のフルステップで評価）など、評価時刻を合わせる工夫で見かけ上の揺れを減らせます。

4) 可視化のスムージング（見た目の対処）
- 学習目的で見やすくしたい場合は、H の移動平均を併記するなどで視認性を上げられます（物理的には本質ではありません）。

### まとめ
- 波打ちはバグではなく、現在の（シンプレクティック）数値積分の特性です。
- 真に一定の直線に近づけたい場合は「dt を小さくする」または「Velocity-Verlet などの高品質なシンプレクティック法に変更する」のが有効です。
- 位置と速度の時刻ずれをそろえることも、H の小さな周期振動を軽減します。